# JVM Configuration for ElasticSearch
# ===================================
# See <https://github.com/elasticsearch/elasticsearch/blob/master/bin/elasticsearch.in.sh>
#

<%= "JAVA_HOME='#{node.elasticsearch[:java_home]}'\n" if node.elasticsearch[:java_home] -%>
ES_HOME='<%= "#{node.elasticsearch[:dir]}/elasticsearch" %>'
ES_CLASSPATH=$ES_CLASSPATH:$ES_HOME/lib/*:$ES_HOME/lib/sigar/*
ES_HEAP_SIZE=<%= node.elasticsearch[:allocated_memory] %>

ES_JAVA_OPTS="
  -server
  -Djava.net.preferIPv4Stack=true
  -Des.config=<%= node.elasticsearch[:path][:conf] %>/elasticsearch.yml
  -Xms<%= node.elasticsearch[:allocated_memory] %>
  -Xmx<%= node.elasticsearch[:allocated_memory] %>
  -Xss<%= node.elasticsearch[:thread_stack_size] %>
  -XX:+UseParNewGC
  -XX:+UseConcMarkSweepGC
  -XX:CMSInitiatingOccupancyFraction=75
  -XX:+UseCMSInitiatingOccupancyOnly
  -XX:+HeapDumpOnOutOfMemoryError


<% if node.elasticsearch[:jmx] %>
  	-Dcom.sun.management.jmxremote.ssl=<%= node.elasticsearch[:jmx_config][:ssl] %>
  	-Dcom.sun.management.jmxremote.authenticate=<%= node.elasticsearch[:jmx_config][:authenticate] %>
  	-Dcom.sun.management.jmxremote.port=<%= node.elasticsearch[:jmx_config][:port] %>
  	<% if node.elasticsearch[:jmx_config][:hostname_fqdn] %>
  		-Djava.rmi.server.hostname=<%= node[:fqdn] %>
  	<% else %>
  		-Djava.rmi.server.hostname=<%= node[:ipadress] %>
  	<% end %>
	<% if node.elasticsearch[:jmx_config][:authenticate] %>
  		-Dcom.sun.management.jmxremote.password.file=<%= node.elasticsearch[:jmx_config][:password_file] %>
  		-Dcom.sun.management.jmxremote.access.file=<%= node.elasticsearch[:jmx_config][:access_file] %>
	<% end %>

	<% if node.elasticsearch[:jmx_config][:ssl] %>
		-Djavax.net.ssl.keyStore=<%= node.elasticsearch[:jmx_config][:keystore] %>
		-Djavax.net.ssl.keyStorePassword=<%= node.elasticsearch[:jmx_config][:keystorepassword] %>
		-Djavax.net.ssl.trustStore=<%= node.elasticsearch[:jmx_config][:truststore] %>
		-Djavax.net.ssl.trustStorePassword=<%= node.elasticsearch[:jmx_config][:truststorepassword] %>
		-Dcom.sun.management.jmxremote.ssl.need.client.auth=<%= node.elasticsearch[:jmx_config][:nedd_client_auth] %>
	<% end %>

<% end %>
"

